version: 2.1

orbs:
  android: circleci/android@1.0.3

commands:
  write-keystore-files:
    steps:
      - run:
          name: Write Wisefy release keystore
          command: echo "$WISEFY_RELEASE_KEYSTORE" | base64 --decode > keystores/wisefy-release.jks
      - run:
          name: Write Wisefy sample release keystore
          command: echo "$WISEFY_SAMPLE_RELEASE_KEYSTORE" | base64 --decode > keystores/wisefy-sample-release.jks

jobs:
  static-analysis:
    executor:
      name: android/android-machine
    steps:
      - checkout
      - write-keystore-files
      - run:
          name: Run lint
          command: ./gradlew lintDebug
      - run:
          name: Run Kotlinter
          command: ./gradlew lintKotlin
      - run:
          name: Run detekt
          command: ./gradlew detekt
      - run:
          name: Run CPD
          command: ./gradlew cpdCheck

  build:
    executor:
      name: android/android-machine
    steps:
      - checkout
      - write-keystore-files
      - run:
          name: Assemble debug build
          command: ./gradlew assembleDebug
      - run:
          name: Assemble release build
          command: ./gradlew assembleRelease

workflows:
  wisefy-ci-cd:
    jobs:
      - static-analysis
      - build
